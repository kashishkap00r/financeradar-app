<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Indian Finance Radar</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0c121a;
      --text:#e9eef7;
      --muted:#9fb0c8;
      --muted2:#6f819a;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --accent:#7c5cff;
      --accent2:#2de1c2;
      --chip: rgba(124,92,255,.15);
      --chipBorder: rgba(124,92,255,.25);
      --radius: 16px;
      --radius2: 12px;
      --danger:#ff6b6b;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --panel:#ffffff;
        --panel2:#fbfcff;
        --text:#111827;
        --muted:#4b5563;
        --muted2:#6b7280;
        --border:rgba(17,24,39,.10);
        --shadow: 0 10px 30px rgba(17,24,39,.12);
        --chip: rgba(124,92,255,.10);
        --chipBorder: rgba(124,92,255,.18);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 700px at 90% 0%, rgba(45,225,194,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px 16px 56px;
    }

    /* Top header block like the screenshot */
    .hero{
      border-radius: var(--radius);
      padding: 18px 20px;
      background: linear-gradient(180deg, rgba(20,16,40,.92), rgba(14,12,28,.92));
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
    }
    @media (prefers-color-scheme: light){
      .hero{
        background: linear-gradient(180deg, rgba(124,92,255,.14), rgba(45,225,194,.10));
        border: 1px solid var(--border);
      }
    }

    .heroTitle{
      margin:0;
      font-size: 18px;
      font-weight: 850;
      letter-spacing: .2px;
    }
    .heroSub{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,.75);
    }
    @media (prefers-color-scheme: light){
      .heroSub{ color: var(--muted); }
    }

    /* Controls panel */
    .panel{
      margin-top: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    @media (prefers-color-scheme: light){
      .panel{ background: rgba(17,24,39,.02); }
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .search{
      flex: 1;
      min-width: 240px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    @media (prefers-color-scheme: light){
      .search{ background: rgba(17,24,39,.03); }
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background: transparent;
      color: var(--text);
      font-size: 13px;
    }

    select{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      min-width: 190px;
      outline: none;
    }
    @media (prefers-color-scheme: light){
      select{ background: rgba(17,24,39,.03); }
    }

    .toggles{
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
      margin-left:auto;
    }

    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .toggle input{ transform: translateY(1px); }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      cursor:pointer;
      transition: .15s ease;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    @media (prefers-color-scheme: light){
      .btn{ background: rgba(17,24,39,.03); }
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn:active{ transform: translateY(0); }

    .metaRow{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .metaRow strong{ color: var(--text); font-weight: 750; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }

    /* List */
    .state{
      margin-top: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding: 18px;
      color: var(--muted);
      font-size: 13px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    .list{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 1px 0 rgba(255,255,255,.06);
      transition: .15s ease;
    }
    @media (prefers-color-scheme: light){
      .card{ background: linear-gradient(180deg, rgba(255,255,255,1), rgba(251,252,255,1)); }
    }
    .card:hover{
      transform: translateY(-1px);
      box-shadow: var(--shadow);
      border-color: rgba(124,92,255,.35);
    }
    .card.read{
      opacity: .72;
    }

    .cardTop{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }

    .headline{
      margin:0;
      font-size: 14px;
      line-height: 1.35;
      font-weight: 760;
    }
    .headline a{
      color: var(--text);
      text-decoration:none;
    }
    .headline a:hover{ text-decoration:underline; }

    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-shrink:0;
    }
    .mini{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor:pointer;
      transition:.12s ease;
    }
    .mini:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .mini:active{ transform: translateY(0); }
    .mini.starred{ border-color: rgba(45,225,194,.35); }
    .mini.read{ border-color: rgba(124,92,255,.35); }

    .sub{
      margin-top: 8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--chipBorder);
      color: var(--text);
      font-size: 11px;
    }

    .pillSmall{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
    }

    .muted{ color: var(--muted2); }

    .footer{
      margin-top: 22px;
      color: var(--muted2);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    code{ color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="hero">
      <h1 class="heroTitle">Indian Finance Radar</h1>
      <div class="heroSub" id="heroSub">Loadingâ€¦</div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="search">
          <input id="q" placeholder="Search newsâ€¦" autocomplete="off" />
        </div>

        <select id="sourceSel" title="Filter by source">
          <option value="">All Sources</option>
        </select>

        <select id="topicSel" title="Filter by topic">
          <option value="">All Topics</option>
        </select>

        <div class="toggles">
          <label class="toggle"><input type="checkbox" id="hideRead"> Hide read</label>
          <label class="toggle"><input type="checkbox" id="starOnly"> Starred only</label>
          <button class="btn" id="refreshBtn" title="Refresh">âŸ³ Refresh</button>
        </div>
      </div>

      <div class="metaRow">
        <div id="metaLeft">â€”</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <span class="pill" id="metaRightA">â€”</span>
          <span class="pill" id="metaRightB">â€”</span>
        </div>
      </div>
    </div>

    <div id="content" class="state">Fetching itemsâ€¦</div>

    <div class="footer">
      <div>Tip: press <code>/</code> to search Â· <code>Esc</code> clears Â· Read/Star is saved on this device.</div>
      <div class="muted">Uses <code>/api/candidates</code> output (<code>{ items: [] }</code>).</div>
    </div>

  </div>

  <script>
    // ====== CONFIG ======
    // Point this to your candidates endpoint. Use absolute if your UI is on a different domain.
    const API_BASE = "https://financeradar.pages.dev/api/candidates";

    // ====== Local state ======
    let state = {
      q: "",
      source: "",
      topic: "",
      hideRead: false,
      starOnly: false,
      data: null,
      fetchedAt: null
    };

    // Read/star persistence (local only)
    const STORE_KEY = "ifr_state_v1";
    const store = loadStore(); // { read: {id:true}, star: {id:true} }

    const el = (id) => document.getElementById(id);

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return { read:{}, star:{} };
        const obj = JSON.parse(raw);
        return {
          read: obj.read && typeof obj.read === "object" ? obj.read : {},
          star: obj.star && typeof obj.star === "object" ? obj.star : {}
        };
      }catch{
        return { read:{}, star:{} };
      }
    }
    function saveStore(){
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function hostFromUrl(url){
      try { return new URL(url).hostname.replace(/^www\./,""); }
      catch { return ""; }
    }

    function fmtTime(d){
      try{
        return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
      }catch{ return "â€”"; }
    }

    function fmtDate(iso){
      if(!iso) return "";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { month:"short", day:"numeric" });
      }catch{ return ""; }
    }

    function uniqSorted(arr){
      return Array.from(new Set(arr)).sort((a,b)=> a.localeCompare(b));
    }

    function buildFilters(items){
      const sources = uniqSorted(items.map(it => it.feed?.title).filter(Boolean));
      const topics  = uniqSorted(items.flatMap(it => Array.isArray(it.tags) ? it.tags : []).filter(Boolean));

      const sourceSel = el("sourceSel");
      const topicSel = el("topicSel");

      // preserve current selection
      const prevSource = state.source;
      const prevTopic = state.topic;

      sourceSel.innerHTML = `<option value="">All Sources</option>` +
        sources.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

      topicSel.innerHTML = `<option value="">All Topics</option>` +
        topics.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      if(prevSource) sourceSel.value = prevSource;
      if(prevTopic) topicSel.value = prevTopic;
    }

    function applyFilters(items){
      const q = state.q.trim().toLowerCase();
      const src = state.source;
      const topic = state.topic;
      const hideRead = state.hideRead;
      const starOnly = state.starOnly;

      return items.filter(it => {
        if(src && (it.feed?.title || "") !== src) return false;
        if(topic && !(Array.isArray(it.tags) && it.tags.includes(topic))) return false;

        const id = String(it.id ?? "");
        const isRead = !!store.read[id];
        const isStar = !!store.star[id];

        if(hideRead && isRead) return false;
        if(starOnly && !isStar) return false;

        if(!q) return true;

        const hay = [
          it.title || "",
          it.feed?.title || "",
          hostFromUrl(it.url || ""),
          Array.isArray(it.tags) ? it.tags.join(" ") : ""
        ].join(" ").toLowerCase();

        return hay.includes(q);
      });
    }

    function render(){
      const content = el("content");
      if(!state.data){
        content.className = "state";
        content.textContent = "Fetching itemsâ€¦";
        return;
      }

      const allItems = Array.isArray(state.data.items) ? state.data.items : [];
      const filtered = applyFilters(allItems);

      // Header meta
      const sourcesCount = new Set(allItems.map(it => it.feed?.title).filter(Boolean)).size;
      const lastUpdated = state.fetchedAt ? fmtTime(state.fetchedAt) : "â€”";

      el("heroSub").textContent =
        `${allItems.length} news articles from ${sourcesCount} sources Â· Last updated: ${lastUpdated}`;

      el("metaLeft").innerHTML =
        `Showing <strong>${filtered.length}</strong> of <strong>${allItems.length}</strong>`;

      el("metaRightA").textContent =
        state.source ? `Source: ${state.source}` : "Source: All";
      el("metaRightB").textContent =
        state.topic ? `Topic: ${state.topic}` : "Topic: All";

      if(filtered.length === 0){
        content.className = "state";
        content.textContent = "No results match your filters.";
        return;
      }

      const parts = [];
      parts.push(`<div class="list">`);
      for(const it of filtered){
        parts.push(renderItem(it));
      }
      parts.push(`</div>`);

      content.className = "";
      content.innerHTML = parts.join("");
      wireCardButtons();
    }

    function renderItem(it){
      const id = String(it.id ?? "");
      const title = escapeHtml(it.title || "");
      const url = it.url || "#";
      const feedTitle = escapeHtml(it.feed?.title || hostFromUrl(url) || "Source");
      const domain = escapeHtml(hostFromUrl(url));
      const when = fmtDate(it.published_at);

      const tags = Array.isArray(it.tags) ? it.tags.slice(0, 3) : [];
      const tagChips = tags.map(t => `<span class="chip">#${escapeHtml(t)}</span>`).join("");

      const isRead = !!store.read[id];
      const isStar = !!store.star[id];

      return `
        <div class="card ${isRead ? "read" : ""}" data-id="${escapeHtml(id)}">
          <div class="cardTop">
            <h3 class="headline">
              <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${title}</a>
            </h3>
            <div class="actions">
              <button class="mini ${isStar ? "starred" : ""}" data-action="star">${isStar ? "Starred" : "Star"}</button>
              <button class="mini ${isRead ? "read" : ""}" data-action="read">${isRead ? "Read" : "Mark read"}</button>
            </div>
          </div>

          <div class="sub">
            <span class="chip">ðŸ“° ${feedTitle}</span>
            ${domain ? `<span class="pillSmall">${domain}</span>` : ""}
            ${when ? `<span class="pillSmall">${escapeHtml(when)}</span>` : ""}
            ${tagChips}
          </div>
        </div>
      `;
    }

    function wireCardButtons(){
      document.querySelectorAll(".card .mini").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.preventDefault();
          e.stopPropagation();

          const action = btn.dataset.action;
          const card = btn.closest(".card");
          const id = card?.dataset?.id;
          if(!id) return;

          if(action === "read"){
            store.read[id] = !store.read[id];
          }else if(action === "star"){
            store.star[id] = !store.star[id];
          }

          saveStore();
          render(); // simplest: rerender
        });
      });

      // Mark read when user clicks the headline (optional but useful)
      document.querySelectorAll(".card .headline a").forEach(a=>{
        a.addEventListener("click", ()=>{
          const card = a.closest(".card");
          const id = card?.dataset?.id;
          if(!id) return;
          store.read[id] = true;
          saveStore();
          // no render here; let navigation happen
        });
      });
    }

    async function fetchCandidates(){
      // NOTE: Your API now hard-codes 5 days. No need to pass days param.
      const url = new URL(API_BASE);
      // optionally control list size:
      // url.searchParams.set("top","150");

      const resp = await fetch(url.toString(), { cache: "no-store" });
      const data = await resp.json();

      if(!resp.ok){
        const msg = data?.error ? `${data.error}` : `HTTP ${resp.status}`;
        throw new Error(msg);
      }
      return data; // expects { items: [...] }
    }

    async function fetchAndRender(){
      const content = el("content");
      content.className = "state";
      content.textContent = "Fetching itemsâ€¦";

      try{
        const data = await fetchCandidates();
        state.data = data;
        state.fetchedAt = new Date();

        const items = Array.isArray(data.items) ? data.items : [];
        buildFilters(items);
        render();
      }catch(err){
        state.data = null;
        content.className = "state";
        content.textContent = `Failed to load: ${err.message || err}`;
      }
    }

    // ====== Events ======
    el("q").addEventListener("input", (e)=> { state.q = e.target.value; render(); });
    el("sourceSel").addEventListener("change", (e)=> { state.source = e.target.value; render(); });
    el("topicSel").addEventListener("change", (e)=> { state.topic = e.target.value; render(); });

    el("hideRead").addEventListener("change", (e)=> { state.hideRead = e.target.checked; render(); });
    el("starOnly").addEventListener("change", (e)=> { state.starOnly = e.target.checked; render(); });

    el("refreshBtn").addEventListener("click", fetchAndRender);

    // Keyboard shortcuts
    window.addEventListener("keydown", (e)=>{
      if(e.key === "/" && document.activeElement !== el("q")){
        e.preventDefault();
        el("q").focus();
      }
      if(e.key === "Escape"){
        el("q").value = "";
        state.q = "";
        render();
        el("q").blur();
      }
    });

    // Initial
    fetchAndRender();
  </script>
</body>
</html>
