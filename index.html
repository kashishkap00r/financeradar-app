<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Indian Finance Radar</title>

  <style>
    :root{
      --bg:#f6f7fb; --bgGlow1:rgba(124,92,255,.14); --bgGlow2:rgba(45,225,194,.10);
      --panel:#ffffff; --panelSoft:rgba(17,24,39,.02); --panelInput:rgba(17,24,39,.03);
      --text:#111827; --muted:#4b5563; --muted2:#6b7280;
      --border:rgba(17,24,39,.10); --shadow:0 10px 30px rgba(17,24,39,.12);
      --accent:#7c5cff; --accentSoft:rgba(124,92,255,.12);
      --chipBg:rgba(124,92,255,.10); --chipBorder:rgba(124,92,255,.18);
      --radius:16px;
    }
    html[data-theme="dark"]{
      --bg:#0b0f14; --bgGlow1:rgba(124,92,255,.18); --bgGlow2:rgba(45,225,194,.14);
      --panel:#0f1620; --panelSoft:rgba(255,255,255,.03); --panelInput:rgba(255,255,255,.04);
      --text:#e9eef7; --muted:#9fb0c8; --muted2:#6f819a;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.35);
      --accent:#7c5cff; --accentSoft:rgba(124,92,255,.15);
      --chipBg:rgba(124,92,255,.15); --chipBorder:rgba(124,92,255,.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% -10%, var(--bgGlow1), transparent 60%),
        radial-gradient(900px 700px at 90% 0%, var(--bgGlow2), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1080px;margin:0 auto;padding:18px 16px 56px}

    .hero{
      border-radius:var(--radius);
      padding:18px 20px;
      background:linear-gradient(180deg,var(--accentSoft),var(--panelSoft));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
    }
    .heroTitle{margin:0;font-size:18px;font-weight:850;letter-spacing:.2px}
    .heroSub{margin-top:6px;font-size:12px;color:var(--muted)}
    .heroRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid var(--border);
      background:var(--panelInput);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      cursor:pointer;
      transition:.15s ease;
      display:flex;align-items:center;gap:8px;white-space:nowrap;user-select:none;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn:active{transform:translateY(0)}

    .panel{
      margin-top:14px;
      border:1px solid var(--border);
      background:var(--panelSoft);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .search{
      flex:1;min-width:240px;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:var(--panelInput);
    }
    .search input{width:100%;border:0;outline:0;background:transparent;color:var(--text);font-size:13px}
    select{
      border:1px solid var(--border);
      background:var(--panelInput);
      color:var(--text);
      padding:10px 12px;border-radius:12px;font-size:13px;min-width:190px;outline:none;
    }
    .toggles{display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-left:auto}
    .toggle{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;user-select:none;white-space:nowrap}
    .toggle input{transform:translateY(1px)}

    .metaRow{
      margin-top:10px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
      color:var(--muted);font-size:12px;
    }
    .metaRow strong{color:var(--text);font-weight:750}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;font-size:12px;color:var(--muted);
      border:1px solid var(--border);background:var(--panelInput);white-space:nowrap;
    }

    .pager{margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pageBtns{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pageBtn{
      border:1px solid var(--border);
      background:var(--panelInput);
      color:var(--text);
      padding:8px 10px;border-radius:10px;font-size:12px;cursor:pointer;
      transition:.12s ease;min-width:38px;text-align:center;user-select:none;
    }
    .pageBtn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .pageBtn:active{transform:translateY(0)}
    .pageBtn.active{border-color:rgba(124,92,255,.45);box-shadow:0 0 0 3px rgba(124,92,255,.12);font-weight:800}
    .pageBtn:disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}

    .state{
      margin-top:14px;border:1px solid var(--border);background:var(--panelSoft);
      border-radius:var(--radius);padding:18px;color:var(--muted);font-size:13px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel));
      border:1px solid var(--border);border-radius:var(--radius);
      padding:14px;box-shadow:0 1px 0 rgba(255,255,255,.06);transition:.15s ease;
    }
    .card:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:rgba(124,92,255,.35)}
    .card.read{opacity:.72}
    .cardTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .headline{margin:0;font-size:14px;line-height:1.35;font-weight:760}
    .headline a{color:var(--text);text-decoration:none}
    .headline a:hover{text-decoration:underline}
    .actions{display:flex;gap:8px;align-items:center;flex-shrink:0}
    .mini{
      border:1px solid var(--border);background:var(--panelInput);color:var(--text);
      padding:6px 10px;border-radius:10px;font-size:12px;cursor:pointer;transition:.12s ease;
      user-select:none;
    }
    .mini:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .mini:active{transform:translateY(0)}
    .mini.starred{border-color:rgba(45,225,194,.35)}
    .mini.read{border-color:rgba(124,92,255,.35)}
    .sub{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      background:var(--chipBg);border:1px solid var(--chipBorder);color:var(--text);font-size:11px;
    }
    .pillSmall{
      display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;font-size:11px;
      color:var(--muted);border:1px solid var(--border);background:var(--panelInput);
    }
    .footer{margin-top:22px;color:var(--muted2);font-size:12px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    code{color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1 class="heroTitle">Indian Finance Radar</h1>
        <div class="heroSub" id="heroSub">Loadingâ€¦</div>
      </div>
      <div class="heroRight">
        <button class="btn" id="themeBtn" title="Toggle Day/Night">ðŸŒž Day</button>
        <button class="btn" id="refreshBtn" title="Refresh">âŸ³ Refresh</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="search">
          <input id="q" placeholder="Search newsâ€¦" autocomplete="off" />
        </div>

        <select id="sourceSel" title="Filter by source">
          <option value="">All Sources</option>
        </select>

        <select id="topicSel" title="Filter by topic">
          <option value="">All Topics</option>
        </select>

        <div class="toggles">
          <label class="toggle"><input type="checkbox" id="hideRead"> Hide read</label>
          <label class="toggle"><input type="checkbox" id="starOnly"> Starred only</label>
        </div>
      </div>

      <div class="metaRow">
        <div id="metaLeft">â€”</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <span class="pill" id="metaRightA">â€”</span>
          <span class="pill" id="metaRightB">â€”</span>
        </div>
      </div>

      <div class="pager">
        <div class="pill" id="pageMeta">Page â€” of â€”</div>
        <div class="pageBtns" id="pageBtns"></div>
      </div>
    </div>

    <div id="content" class="state">Fetching itemsâ€¦</div>

    <div class="footer">
      <div>Tip: press <code>/</code> to search Â· <code>Esc</code> clears Â· Read/Star saved on this device.</div>
      <div class="muted">Uses <code>/api/candidates?top=500</code> and paginates client-side.</div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  // If API is on same domain as this UI:
  //   const API_BASE = "/api/candidates";
  // If API is on another domain:
  //   const API_BASE = "https://financeradar.kashishkapoor.com/api/candidates";
  const API_BASE = "/api/candidates";

  const FETCH_TOP = 500;
  const PAGE_SIZE = 50;
  const MAX_VISIBLE_PAGES = 10;

  // =========================
  // Helpers + DOM
  // =========================
  const el = (id) => document.getElementById(id);

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function hostFromUrl(url){
    try { return new URL(url).hostname.replace(/^www\./,""); }
    catch { return ""; }
  }
  function fmtTime(d){
    try{ return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" }); }
    catch{ return "â€”"; }
  }
  function fmtDate(iso){
    if(!iso) return "";
    try{
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { month:"short", day:"numeric" });
    }catch{ return ""; }
  }
  function uniqSorted(arr){
    return Array.from(new Set(arr)).sort((a,b)=> a.localeCompare(b));
  }

  // =========================
  // Theme (light default)
  // =========================
  const THEME_KEY = "ifr_theme";
  function updateThemeButton(theme){
    const btn = el("themeBtn");
    if(!btn) return;
    if(theme === "dark"){
      btn.textContent = "ðŸŒ™ Night";
      btn.title = "Switch to Day";
    }else{
      btn.textContent = "ðŸŒž Day";
      btn.title = "Switch to Night";
    }
  }
  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    const theme = (saved === "dark" || saved === "light") ? saved : "light";
    document.documentElement.setAttribute("data-theme", theme);
    updateThemeButton(theme);
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "light";
    const next = cur === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem(THEME_KEY, next);
    updateThemeButton(next);
  }

  // =========================
  // Read/Star store
  // =========================
  const STORE_KEY = "ifr_state_v2";
  function loadStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return { read:{}, star:{} };
      const obj = JSON.parse(raw);
      return {
        read: obj.read && typeof obj.read === "object" ? obj.read : {},
        star: obj.star && typeof obj.star === "object" ? obj.star : {}
      };
    }catch{
      return { read:{}, star:{} };
    }
  }
  const store = loadStore();
  function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }

  // =========================
  // App state
  // =========================
  let state = {
    q: "",
    source: "",
    topic: "",
    hideRead: false,
    starOnly: false,
    data: null,
    fetchedAt: null,
    page: 1
  };

  // Must run AFTER el() is defined
  initTheme();

  // =========================
  // Filters + Pagination
  // =========================
  function buildFilters(items){
    const sources = uniqSorted(items.map(it => it.feed?.title).filter(Boolean));
    const topics  = uniqSorted(items.flatMap(it => Array.isArray(it.tags) ? it.tags : []).filter(Boolean));

    const sourceSel = el("sourceSel");
    const topicSel = el("topicSel");

    const prevSource = state.source;
    const prevTopic = state.topic;

    sourceSel.innerHTML = `<option value="">All Sources</option>` +
      sources.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

    topicSel.innerHTML = `<option value="">All Topics</option>` +
      topics.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

    if(prevSource) sourceSel.value = prevSource;
    if(prevTopic) topicSel.value = prevTopic;
  }

  function applyFilters(items){
    const q = state.q.trim().toLowerCase();
    const src = state.source;
    const topic = state.topic;

    return items.filter(it => {
      if(src && (it.feed?.title || "") !== src) return false;
      if(topic && !(Array.isArray(it.tags) && it.tags.includes(topic))) return false;

      const id = String(it.id ?? "");
      const isRead = !!store.read[id];
      const isStar = !!store.star[id];

      if(state.hideRead && isRead) return false;
      if(state.starOnly && !isStar) return false;

      if(!q) return true;

      const hay = [
        it.title || "",
        it.feed?.title || "",
        hostFromUrl(it.url || ""),
        Array.isArray(it.tags) ? it.tags.join(" ") : ""
      ].join(" ").toLowerCase();

      return hay.includes(q);
    });
  }

  function clampPage(p, totalPages){
    if(totalPages <= 0) return 1;
    return Math.max(1, Math.min(totalPages, p));
  }

  function getPaged(items){
    const totalPages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
    state.page = clampPage(state.page, totalPages);
    const start = (state.page - 1) * PAGE_SIZE;
    return { pageItems: items.slice(start, start + PAGE_SIZE), totalPages };
  }

  function renderPagination(totalPages){
    el("pageMeta").textContent = `Page ${state.page} of ${totalPages}`;
    const box = el("pageBtns");

    const visiblePages = Math.min(totalPages, MAX_VISIBLE_PAGES);
    const parts = [];

    parts.push(`<button class="pageBtn" data-page="prev" ${state.page===1?"disabled":""}>Prev</button>`);
    for(let p=1; p<=visiblePages; p++){
      parts.push(`<button class="pageBtn ${p===state.page?"active":""}" data-page="${p}">${p}</button>`);
    }
    parts.push(`<button class="pageBtn" data-page="next" ${state.page===totalPages?"disabled":""}>Next</button>`);

    box.innerHTML = parts.join("");

    box.querySelectorAll(".pageBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const v = btn.getAttribute("data-page");
        if(v === "prev") state.page = Math.max(1, state.page - 1);
        else if(v === "next") state.page = Math.min(totalPages, state.page + 1);
        else state.page = parseInt(v, 10) || 1;
        render();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
  }

  // =========================
  // Render
  // =========================
  function render(){
    const content = el("content");
    if(!state.data){
      content.className = "state";
      content.textContent = "Fetching itemsâ€¦";
      return;
    }

    const allItems = Array.isArray(state.data.items) ? state.data.items : [];
    const filtered = applyFilters(allItems);

    const sourcesCount = new Set(allItems.map(it => it.feed?.title).filter(Boolean)).size;
    const lastUpdated = state.fetchedAt ? fmtTime(state.fetchedAt) : "â€”";

    el("heroSub").textContent =
      `${allItems.length} news articles from ${sourcesCount} sources Â· Last updated: ${lastUpdated}`;

    el("metaLeft").innerHTML =
      `Showing <strong>${filtered.length}</strong> of <strong>${allItems.length}</strong>`;

    el("metaRightA").textContent = state.source ? `Source: ${state.source}` : "Source: All";
    el("metaRightB").textContent = state.topic ? `Topic: ${state.topic}` : "Topic: All";

    if(filtered.length === 0){
      renderPagination(1);
      content.className = "state";
      content.textContent = "No results match your filters.";
      return;
    }

    const { pageItems, totalPages } = getPaged(filtered);
    renderPagination(totalPages);

    const parts = [];
    parts.push(`<div class="list">`);
    for(const it of pageItems) parts.push(renderItem(it));
    parts.push(`</div>`);

    content.className = "";
    content.innerHTML = parts.join("");
    wireCardButtons();
  }

  function renderItem(it){
    const id = String(it.id ?? "");
    const title = escapeHtml(it.title || "");
    const url = it.url || "#";
    const feedTitle = escapeHtml(it.feed?.title || hostFromUrl(url) || "Source");
    const domain = escapeHtml(hostFromUrl(url));
    const when = fmtDate(it.published_at);

    const tags = Array.isArray(it.tags) ? it.tags.slice(0, 3) : [];
    const tagChips = tags.map(t => `<span class="chip">#${escapeHtml(t)}</span>`).join("");

    const isRead = !!store.read[id];
    const isStar = !!store.star[id];

    return `
      <div class="card ${isRead ? "read" : ""}" data-id="${escapeHtml(id)}">
        <div class="cardTop">
          <h3 class="headline">
            <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${title}</a>
          </h3>
          <div class="actions">
            <button class="mini ${isStar ? "starred" : ""}" data-action="star">${isStar ? "Starred" : "Star"}</button>
            <button class="mini ${isRead ? "read" : ""}" data-action="read">${isRead ? "Read" : "Mark read"}</button>
          </div>
        </div>

        <div class="sub">
          <span class="chip">ðŸ“° ${feedTitle}</span>
          ${domain ? `<span class="pillSmall">${domain}</span>` : ""}
          ${when ? `<span class="pillSmall">${escapeHtml(when)}</span>` : ""}
          ${tagChips}
        </div>
      </div>
    `;
  }

  function wireCardButtons(){
    document.querySelectorAll(".card .mini").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        const action = btn.dataset.action;
        const card = btn.closest(".card");
        const id = card?.dataset?.id;
        if(!id) return;

        if(action === "read") store.read[id] = !store.read[id];
        if(action === "star") store.star[id] = !store.star[id];

        saveStore();
        render();
      });
    });

    document.querySelectorAll(".card .headline a").forEach(a=>{
      a.addEventListener("click", ()=>{
        const card = a.closest(".card");
        const id = card?.dataset?.id;
        if(!id) return;
        store.read[id] = true;
        saveStore();
      });
    });
  }

  // =========================
  // Fetch
  // =========================
  function buildApiUrl(){
    // If API_BASE is absolute (starts with http), use it directly.
    // If it's relative (/api/candidates), resolve against current site origin.
    const base = API_BASE.startsWith("http") ? API_BASE : (window.location.origin + API_BASE);
    const url = new URL(base);
    url.searchParams.set("top", String(FETCH_TOP));
    return url.toString();
  }

  async function fetchCandidates(){
    const url = buildApiUrl();
    const resp = await fetch(url, { cache: "no-store" });

    const text = await resp.text();
    let data;
    try { data = JSON.parse(text); }
    catch {
      // This usually means you hit a 404 HTML page or a proxy returning non-JSON
      throw new Error("API did not return JSON. Check API_BASE and /api/candidates path.");
    }

    if(!resp.ok){
      const msg = data?.error ? `${data.error}` : `HTTP ${resp.status}`;
      throw new Error(msg);
    }
    return data;
  }

  async function fetchAndRender(){
    const content = el("content");
    content.className = "state";
    content.textContent = "Fetching itemsâ€¦";

    try{
      const data = await fetchCandidates();
      state.data = data;
      state.fetchedAt = new Date();
      state.page = 1;

      const items = Array.isArray(data.items) ? data.items : [];
      buildFilters(items);
      render();
    }catch(err){
      state.data = null;
      content.className = "state";
      content.textContent = `Failed to load: ${err.message || err}`;
      // Also update header so you can see it without opening console
      el("heroSub").textContent = `Error: ${err.message || err}`;
    }
  }

  // =========================
  // Events
  // =========================
  el("q").addEventListener("input", (e)=> { state.q = e.target.value; state.page = 1; render(); });
  el("sourceSel").addEventListener("change", (e)=> { state.source = e.target.value; state.page = 1; render(); });
  el("topicSel").addEventListener("change", (e)=> { state.topic = e.target.value; state.page = 1; render(); });

  el("hideRead").addEventListener("change", (e)=> { state.hideRead = e.target.checked; state.page = 1; render(); });
  el("starOnly").addEventListener("change", (e)=> { state.starOnly = e.target.checked; state.page = 1; render(); });

  el("refreshBtn").addEventListener("click", fetchAndRender);
  el("themeBtn").addEventListener("click", toggleTheme);

  window.addEventListener("keydown", (e)=>{
    if(e.key === "/" && document.activeElement !== el("q")){
      e.preventDefault(); el("q").focus();
    }
    if(e.key === "Escape"){
      el("q").value = ""; state.q = ""; state.page = 1; render(); el("q").blur();
    }
  });

  // Initial load
  fetchAndRender();
</script>
</body>
</html>
