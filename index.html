<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FinanceRadar</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#070A0F;
      --panel:#0B1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --text:rgba(255,255,255,.92);
      --accent:#7C3AED;
      --accent2:#22D3EE;
      --good:#10B981;
      --warn:#F59E0B;
      --bad:#EF4444;
      --radius:18px;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --blur: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(900px 700px at 15% 0%, rgba(124,58,237,.20), transparent 55%),
        radial-gradient(900px 700px at 90% 0%, rgba(45,225,194,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(124,58,237,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }

    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:1100px; margin:0 auto; padding:26px 18px 60px; }

    /* Top bar */
    .top{
      position:sticky; top:0; z-index:10;
      padding:16px 0 18px;
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      background: linear-gradient(to bottom, rgba(7,10,15,.85), rgba(7,10,15,.55), rgba(7,10,15,0));
      border-bottom: 1px solid rgba(255,255,255,.05);
    }

    .brandRow{
      display:flex; align-items:center; gap:14px;
    }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.95), rgba(124,58,237,.9) 50%, rgba(124,58,237,.4) 90%);
      box-shadow: 0 12px 30px rgba(124,58,237,.25);
    }
    .titleBlock .title{
      font-weight:750; letter-spacing:.2px; font-size:18px;
      display:flex; align-items:center; gap:10px;
    }
    .titleBlock .subtitle{
      margin-top:2px;
      font-size:12px; color:var(--muted2);
    }

    .controls{
      margin-top:14px;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }

    .seg{
      display:flex; padding:4px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .seg button{
      border:0; background:transparent; color:var(--muted);
      padding:7px 11px; border-radius:999px;
      cursor:pointer; font-size:12px; font-weight:650;
    }
    .seg button.active{
      color:var(--text);
      background: linear-gradient(135deg, rgba(124,58,237,.55), rgba(34,211,238,.25));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
    }

    .search{
      flex:1;
      min-width:240px;
      display:flex; align-items:center;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:8px 12px;
      gap:10px;
    }
    .search .icon{ opacity:.75; font-size:13px; }
    .search input{
      width:100%;
      border:0; outline:0;
      background:transparent;
      color:var(--text);
      font-size:13px;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      display:flex; align-items:center; gap:8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .btn:hover{
      background: rgba(255,255,255,.085);
    }
    .pillBar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:12px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .pill strong{ color:var(--text); }

    /* Content */
    #content{ margin-top:18px; }

    .state{
      padding:18px;
      border-radius:var(--radius);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:13px;
    }

    .day{
      display:flex; align-items:center; gap:12px;
      margin:22px 0 10px;
    }
    .day h2{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      margin:0;
    }
    .day .line{
      height:1px; flex:1;
      background: rgba(255,255,255,.10);
    }

    .list{
      display:flex; flex-direction:column;
      gap:10px;
    }

    .card{
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      padding:14px 14px 12px;
    }

    .cardTop{
      display:flex; gap:12px; align-items:flex-start;
      justify-content:space-between;
    }

    .headline{
      font-size:14px;
      font-weight:750;
      line-height:1.25;
      margin:0;
    }
    .headline a{
      display:inline-block;
    }
    .headline a:hover{
      text-decoration: underline;
      text-underline-offset: 4px;
    }

    .score{
      text-align:right;
      min-width:140px;
      padding-left:10px;
    }
    .score .num{
      font-family:var(--mono);
      font-weight:800;
      font-size:12px;
      color:rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .score .muted{
      margin-top:3px;
      font-family:var(--mono);
      font-size:10px;
      color:rgba(255,255,255,.45);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:220px;
    }

    .sub{
      margin-top:10px;
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center;
    }

    .chip{
      font-size:11px;
      padding:6px 9px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(124,58,237,.18);
      color: rgba(255,255,255,.85);
      display:inline-flex;
      align-items:center;
      gap:6px;
      max-width:100%;
    }
    .chip b{ font-weight:800; }

    .pill{
      font-size:11px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.72);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .why{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.75);
      font-size:12px;
      line-height:1.35;
    }

    @media (max-width:640px){
      .score{ min-width:auto; }
      .score .muted{ display:none; }
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="wrap">
      <div class="brandRow">
        <div class="logo"></div>
        <div class="titleBlock">
          <div class="title">FinanceRadar</div>
          <div class="subtitle">Deduped links from your feeds</div>
        </div>
      </div>

      <div class="controls">
        <div class="seg" id="daysSeg">
          <button data-days="1">1D</button>
          <button data-days="2">2D</button>
          <button data-days="5" class="active">5D</button>
        </div>

        <div class="search">
          <span class="icon">âŒ˜</span>
          <input id="q" placeholder="Search titles, sources, tagsâ€¦" />
        </div>

        <button class="btn" id="refreshBtn">âŸ³ Refresh</button>
      </div>

      <div class="pillBar">
        <div class="pill" id="metaLine">â€”</div>
        <div class="pill" id="metaPerf">â€”</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="content" class="state">Fetching candidatesâ€¦</div>
  </div>

  <script>
    // ===== Config =====
    // Change this if your API lives somewhere else:
    const API_PATH = "/api/candidates";

    const state = {
      days: 5,
      q: "",
      data: null,
      fetchedAt: null,
    };

    // ===== Utilities =====
    const el = (id)=>document.getElementById(id);

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function hostFromUrl(url){
      try { return new URL(url).hostname.replace(/^www\./,""); }
      catch { return ""; }
    }

    function publishedLabel(it){
      const ts = (typeof it.published_ts === "number" && it.published_ts)
        ? it.published_ts
        : Date.parse(it.published_at || "");
      if(!ts || Number.isNaN(ts)) return "";
      const d = new Date(ts);
      const time = d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
      const ageH = (Date.now() - ts) / 36e5;
      const age = ageH < 1 ? `${Math.round(ageH*60)}m` : `${ageH.toFixed(1)}h`;
      return `${time} â€¢ ${age}`;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setDays(days){
      state.days = days;
      document.querySelectorAll("#daysSeg button").forEach(b=>{
        b.classList.toggle("active", Number(b.dataset.days) === Number(days));
      });
      fetchAndRender();
    }

    function formatDay(isoDay){
      // isoDay: YYYY-MM-DD
      if(!isoDay) return "Unknown";
      const [y,m,d] = isoDay.split("-").map(Number);
      const dt = new Date(Date.UTC(y, m-1, d));
      return dt.toLocaleDateString([], { weekday:"short", month:"short", day:"numeric" }).toUpperCase();
    }

    // ===== Filtering =====
    function applyFilter(groups){
      const q = (state.q || "").trim().toLowerCase();
      if(!q) return groups;

      const out = [];
      for(const g of groups){
        const items = (g.items || []).filter(it=>{
          const title = (it.title || "").toLowerCase();
          const feed = (it.feed?.title || "").toLowerCase();
          const domain = hostFromUrl(it.url || "").toLowerCase();
          const tags = Array.isArray(it.tags) ? it.tags.join(" ").toLowerCase() : "";
          const why = (it.why || "").toLowerCase();
          return (
            title.includes(q) ||
            feed.includes(q) ||
            domain.includes(q) ||
            tags.includes(q) ||
            why.includes(q)
          );
        });
        if(items.length) out.push({ day: g.day, items });
      }
      return out;
    }

    // ===== API =====
    async function fetchCandidates(){
      const u = new URL(API_PATH, location.origin);
      u.searchParams.set("days", String(state.days));
      // you can set top here if you want:
      // u.searchParams.set("top", "100");

      const r = await fetch(u.toString(), { cache: "no-store" });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`API ${r.status}: ${t.slice(0,200)}`);
      }
      return await r.json();
    }

    // ===== Rendering =====
    function render(){
      const content = el("content");
      if(!state.data){
        content.className = "state";
        content.textContent = "Fetching candidatesâ€¦";
        return;
      }

      const meta = state.data.meta || {};
      const groupsRaw = state.data.groups || [];
      const groups = applyFilter(groupsRaw);

      // meta bar
      const fetchedLabel = state.fetchedAt
        ? state.fetchedAt.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" })
        : "â€”";

      const info = el("metaLine");
      info.innerHTML =
        `Showing <strong>${(state.data.top || []).length}</strong> items over <strong>${state.days} days</strong> Â· Updated <strong>${fetchedLabel}</strong>`;

      const t = meta.timing || {};
      const ms = typeof t.total_ms === "number" ? t.total_ms : (meta.total_ms || null);
      const fetched = meta.raw_fetched ?? meta.fetched ?? null;
      const pages = meta.pages_fetched ?? meta.pages ?? null;
      const clusters = meta.clusters ?? null;

      const perf = el("metaPerf");
      const parts = [];
      if(ms != null) parts.push(`API <strong>${ms} ms</strong>`);
      if(fetched != null) parts.push(`Fetched <strong>${fetched}</strong>`);
      if(pages != null) parts.push(`Pages <strong>${pages}</strong>`);
      if(clusters != null) parts.push(`Clusters <strong>${clusters}</strong>`);
      perf.innerHTML = parts.length ? parts.join(" Â· ") : "â€”";

      // content
      const out = [];
      for(const g of groups){
        out.push(`
          <div class="day">
            <h2>${escapeHtml(formatDay(g.day))}</h2>
            <div class="line"></div>
          </div>
          <div class="list">
            ${(g.items || []).map(renderItem).join("")}
          </div>
        `);
      }

      content.className = "";
      content.innerHTML = out.join("") || `<div class="state">No results.</div>`;
    }

    function renderItem(it){
      const title = escapeHtml(it.title || "");
      const url = it.url || "#";
      const feedTitle = escapeHtml(it.feed?.title || hostFromUrl(url) || "Source");
      const domain = escapeHtml(hostFromUrl(url));

      const pub = escapeHtml(publishedLabel(it));
      const publishedAt = escapeHtml(it.published_at || "");

      const tags = Array.isArray(it.tags) ? it.tags.slice(0, 3) : [];
      const tagChips = tags.map(t=>`<span class="chip">#${escapeHtml(t)}</span>`).join("");

      const mentions = it.mentions ?? 1;
      const sources = it.sources_count ?? 1;

      return `
        <div class="card">
          <div class="cardTop">
            <h3 class="headline">
              <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${title}</a>
            </h3>
            <div class="score">
              <div class="num">${pub || "â€”"}</div>
              <div class="muted">${publishedAt || ""}</div>
            </div>
          </div>

          <div class="sub">
            <span class="chip">ðŸ“° ${feedTitle}</span>
            ${domain ? `<span class="pill">${domain}</span>` : ""}
            <span class="pill">mentions ${mentions}</span>
            <span class="pill">sources ${sources}</span>
            ${tagChips}
          </div>
        </div>
      `;
    }

    async function fetchAndRender(){
      const content = el("content");
      content.className = "state";
      content.textContent = "Fetching candidatesâ€¦";

      try{
        const data = await fetchCandidates();
        state.data = data;
        state.fetchedAt = new Date();
        render();
      }catch(err){
        state.data = null;
        content.className = "state";
        content.textContent =
          "Failed to load candidates. " + (err?.message || String(err));
      }
    }

    // ===== Wiring =====
    document.querySelectorAll("#daysSeg button").forEach(b=>{
      b.addEventListener("click", ()=> setDays(Number(b.dataset.days)));
    });

    el("refreshBtn").addEventListener("click", fetchAndRender);

    el("q").addEventListener("input", (e)=>{
      state.q = e.target.value || "";
      render();
    });

    // Nice shortcut: press "/" to focus search
    window.addEventListener("keydown", (e)=>{
      if(e.key === "/" && document.activeElement !== el("q")){
        e.preventDefault();
        el("q").focus();
      }
    });

    // Boot
    fetchAndRender();
  </script>
</body>
</html>
